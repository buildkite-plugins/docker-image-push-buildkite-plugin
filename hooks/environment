#!/bin/bash
set -euo pipefail

# Enable debug mode if requested
if [[ "${BUILDKITE_PLUGIN_DOCKER_IMAGE_PUSH_VERBOSE:-false}" =~ (true|on|1) ]]; then
  echo "~~~ :hammer: Enabling debug mode"
  set -x
fi

# Load plugin library
# shellcheck source=lib/plugin.bash
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../lib/plugin.bash"

main() {
  echo "--- :docker: Setting up Docker push environment"
  log_info "Setting up Docker push environment"

  local provider="${BUILDKITE_PLUGIN_DOCKER_IMAGE_PUSH_PROVIDER:-}"
  local image="${BUILDKITE_PLUGIN_DOCKER_IMAGE_PUSH_IMAGE:-}"

  if [[ -z "$provider" ]]; then
    log_error "provider is required"
    exit 1
  fi

  if [[ -z "$image" ]]; then
    log_error "image is required"
    exit 1
  fi

  log_info "Provider - $provider"
  log_info "Image - $image"

  case "$provider" in
  ecr | gar | buildkite | artifactory | namespace) ;;
  *)
    log_error "unsupported provider '$provider'"
    log_info "Supported providers: ecr, gar, buildkite, artifactory, namespace"
    exit 1
    ;;
  esac

  # Authenticate with registry
  setup_provider_environment "$provider"
}

main "$@"
